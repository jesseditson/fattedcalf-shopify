$.fn.appendChain = function() {
  var newEl = $.apply(this, arguments)
  this.append(newEl)
  return newEl
}

var generateCarouselItem = function(idx) {
  var $el = $(this)
  var arrows = $('#page-carousel-arrows').clone().removeAttr('style')
  var link = $el.find('a')
  var href = link.attr('href')
  var title = link.attr('title')
  var image = $el.find('img').attr('src')
  if (!image) return ''
  $el.empty()
  var item = $('<div class="hero__slide">')
  var img = item.appendChain(`<div class="hero__image hero__image--${idx}" data-image="${image}"></div>`).css({
    'background-image': `url('${image}')`
  })
  var textContent = item.appendChain('<div class="hero__text-wrap">').appendChain('<div class="page-width">').appendChain('<div class="hero__text-content">')
  if (title) {
    var h1 = textContent.appendChain('<div class="hero__title-wrap">').appendChain('<h1 class="hero__title">')
    if (href) h1 = h1.addClass('hero__title--has-link').appendChain(`<a href="${href}">`)
    h1.text(title)
  }
  textContent.append(arrows)
  return $('<div>').append(item).html()
}

$(function() {
  $('.page-carousel-content').each(function(idx) {
    var $el = $(this)
    $el.html($el.find('> p').map(generateCarouselItem).get().join(''))
    // TODO: fix these so they work
    $el.on('init', function(evt, obj) {
      debugger
      // TODO: obj.slideCount is 0 here - figure out why and fix.
      var $arrows = $el.find('.hero__arrow')
      theme.heroArrowsInit($arrows, evt, obj)
    })
    $el.slick({
      accessibility  : true,
      arrows         : false, // this theme has custom arrows
      dots           : false,
      draggable      : false,
      autoplay       : $el.data('autoplay'),
      autoplaySpeed  : $el.data('speed')
    })
    // TODO: add this functionality:
    /*
    theme.cache.$heroImage.on('click', function() {
      theme.cache.$hero.slick('slickNext');
    });

    theme.cache.$heroPause.on('click', function() {
      if ($(this).hasClass('is-paused')) {
        theme.heroPlay();
      } else {
        theme.heroPause();
      }
    });
     */
  })
})
